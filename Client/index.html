<html>
    <head>
        <meta charset="utf-8">
        <title>多人射屁股大戰</title>
        <script src="src/Item/Item.js"></script>
        <script src="src/Control/left.js"></script>
        <script src="src/Control/right.js"></script>
        <script src="src/Control/top.js"></script>
        <script src="src/Option.js"></script>
        <script src="src/Login/login.js"></script>
        <script src="src/Login/register.js"></script>
        <script src="src/Hall/HallRoomList.js"></script>
        <script src="src/Hall/HallCommand.js"></script>
        <script src="src/Hall/HallStatus.js"></script>
        <script src="src/NewActor/NewActor.js"></script>
        <script src="../Server/js/ajax.js"></script>
    </head>
    <body></body>
    <script>
        var GameArea,LeftControl,RightControl,TopControl;
        var LoginView,RegView;
        var NewActorView;
        var HallRoomList,HallCommand,HallStatus;
        var Option;
        var player;
        var FocalVar=1;//焦距 最低1
        var MoveCube=[];
        var USERID = null;
        init();
        var testport = location.hash;//URL+testport
        switch (testport) {
            case '#0':
                GameAreaInit();
                break;
            case '#1':
                HallViewInit();
                break;
            default:
                loginViewiInit();
        }
        function init(){
            window.addEventListener( 'resize', onWindowReSize, false );
        }//初始化
        
        function loginViewiInit(){
            /*global LoginView 實作於login.js*/
            LoginView = new LoginView(getWindowSize());
            LoginView.Reg.addEventListener("click",function(){
               document.body.removeChild(LoginView.self);
               document.body.appendChild(RegView.self);
            });
            LoginView.commit.addEventListener("click",function(){
                /*global login 實作於 ajax.js*/
                login(LoginView.getCommit());
            });
            /*global RegisterView 實作於register.js*/
            RegView = new RegisterView(getWindowSize());
            RegView.login.addEventListener("click",function(){
                document.body.removeChild(RegView.self);
                document.body.appendChild(LoginView.self);
            });
            RegView.commit.addEventListener("click",function(){
                /*global register 實作於 ajax.js*/
                register(RegView.getCommit());
            });
            document.body.appendChild(LoginView.self);
        }//登入畫面描繪
        function loginMember(){
            /*global request 實作於 ajax.js*/
			if (request.readyState == 4) {//完成狀態有好幾種，4代表資料傳回完成
				var data = request.responseText;//取得傳回的資料存在變數中
				data = JSON.parse(data);
				if(data.status == "Success"){
				    USERID = data.data.UserID;
				    if(data.data.ActorID == 0){//登入成功但未有角色
				        document.body.removeChild(LoginView.self);
				        NewActorViewInit();  
				    }else{//登入成功且已有角色
				        document.body.removeChild(LoginView.self);
				        GameAreaInit();  
				    }
				}
			}
        }//登入系統函式
        function registerMember(){
            /*global request 實作於 ajax.js*/
				if (request.readyState == 4) {//完成狀態有好幾種，4代表資料傳回完成
					var data = request.responseText;//取得傳回的資料存在變數中
					if(data=="Success#1") alert("註冊成功");
				}
        }//註冊系統函式
        
        function NewActorViewInit(){
            /*global Hall_RoomList,Hall_Command,Hall_Status 實作於Hall.* */
            NewActorView = new NewActorView();
            document.body.appendChild(NewActorView.self);
        }
        function NewActorRequest(){//建立角色成功後
            if (request.readyState == 4) {//完成狀態有好幾種，4代表資料傳回完成
				var data = request.responseText;//取得傳回的資料存在變數中
				console.log(data);
			}
        }
        function HallViewInit(){
            /*global Hall_RoomList,Hall_Command,Hall_Status 實作於Hall.* */
            HallRoomList = new Hall_RoomList();
            HallCommand = new Hall_Command();
            HallStatus = new Hall_Status();
            document.body.appendChild(HallRoomList.self);
            document.body.appendChild(HallCommand.self);
            document.body.appendChild(HallStatus.self);
        }//大廳描繪
        
        
        
        function GameAreaInit(){
            /*global OptionSet 實作於Option.js*/
            Option = new OptionSet();
            document.body.style.width = Option.GameAreaWidth;
            document.body.style.height = Option.GameAreaHeight;
            GameArea = document.createElement("div");
            GameArea.style.width = "70%";
            GameArea.style.height = "70%";
            GameArea.style.backgroundColor = "#FFAC55";
            GameArea.style.margin = "0 auto";
            GameArea.style.position = 'absolute';
            GameArea.style.top = "20%";
            GameArea.style.left = "15%";
            document.body.appendChild(GameArea);
            TopControl =new TopControl();
            TopControl.ZoomButton1.addEventListener("click",function(){
                zoom("300%");
            });
            TopControl.ZoomButton2.addEventListener("click",function(){
                zoom("200%");
            });
            TopControl.ZoomButton3.addEventListener("click",function(){
                zoom("100%");
            });
            
            document.body.appendChild((TopControl.self));
            
            
            LeftControl = new LeftControl();
            LeftControl.MoveButton.addEventListener("click",function(){
                MoveItem(); 
            });
            document.body.appendChild(LeftControl.self);
            
            RightControl = new RightControl();
            document.body.appendChild(RightControl.self);
            /*global Item 實作於Item.js*/
            for(var i=0;i<Option.CubeX;i++){
                MoveCube.push([]);
                for(var j=0;j<Option.CubeY;j++){
                    var item = new Item(j,i,0,"space");
                    MoveCube[i].push(item);
                }
            }
            var focalPos = new Object();
            focalPos.X = Option.CubeX / 2;
            focalPos.Y = Option.CubeY / 2;
            rendCube(focalPos);
            
            //以下測試插入玩家
            player = new Item(5,5,1,"player","+",2);//x,y,ID,Type,MoveType,MoveRange
            addItem(player);
        }//遊戲畫面初始化
        function zoom(size){
            GameArea.style.zoom=size;
        }
        function rendCube(centerPos){//centerPos = 聚焦中心位置
            var X_num = Option.CubeX/FocalVar;//X軸顯示數量
            var Y_num = Option.CubeY/FocalVar;//Y軸顯示數量
            var min_X = centerPos.X - X_num;
            var max_X = centerPos.X + X_num;
            var min_Y = centerPos.Y - Y_num;
            var max_Y = centerPos.Y + Y_num;
            
            for(var i=min_X;i<max_X;i++){
                if(i<0) continue;
                if(i>=Option.CubeX) break;
                for(var j=min_Y;j<max_Y;j++){
                    if(j<0) continue;
                    if(j>=Option.CubeY) break;
                    MoveCube[i][j].Div.style.width = Option.CubeSize*FocalVar + "px";
                    MoveCube[i][j].Div.style.height = Option.CubeSize*FocalVar + "px";
                    switch (MoveCube[i][j].Type) {
                        case 'player':
                            MoveCube[i][j].Div.style.backgroundColor = "#FF0000";//for TEST
                            console.log(i+","+j);
                            break;
                        case 'move':
                            MoveCube[i][j].Div.style.backgroundColor = "#FFFF00";//for TEST
                            break;
                        default:
                            MoveCube[i][j].Div.style.backgroundColor = "#FFFFFF";//for TEST
                    }
                    if(min_X < 0) MoveCube[i][j].Div.style.left = (i * (Option.CubeSize + Option.CubeLine * 2) * FocalVar ) + "px";
                    else MoveCube[i][j].Div.style.left = ((i-min_X) * (Option.CubeSize + Option.CubeLine * 2) * FocalVar ) + "px";
                    if(min_Y < 0) MoveCube[i][j].Div.style.top = (j * (Option.CubeSize + Option.CubeLine * 2) * FocalVar ) + "px";
                    else MoveCube[i][j].Div.style.top = ((j-min_Y) * (Option.CubeSize + Option.CubeLine * 2) * FocalVar ) + "px";
                    GameArea.appendChild(MoveCube[i][j].Div);
                }
            }
        }//畫面描繪
        
        function addItem(Item){
            var x = Item.Postion.X;
            var y = Item.Postion.Y;
            MoveCube[x][y] = Item;
            var focalPos = new Object();
            focalPos.X = x;
            focalPos.Y = y;
            rendCube(focalPos);
        }//加入玩家，發射彈藥
        
        function MoveItem(){
            function addEvent(x,y){//按下移動按鈕後
                MoveCube[x][y].Div.addEventListener("click",function(){
                    MoveCube[player.Postion.X][player.Postion.Y] = player.clone();//物件複製
                    MoveCube[player.Postion.X][player.Postion.Y].No=0;
                    MoveCube[player.Postion.X][player.Postion.Y].Type="space";
                    player.Postion.X=x;
                    player.Postion.Y=y;
                    MoveCube[x][y] = player.clone();
                    rendCube(player.Postion);
                });
            }
            var CenterX = player.Postion.X;
            var CenterY = player.Postion.Y;
            switch (player.property.MoveType) {//依照移動類型描繪可移動目標
                case '+':
                    for(var i=0;i<4;i++){
                        for(var j=1;j<=player.property.MoveAbility;j++){
                            switch (i) {
                                case 0:
                                    //偵測是否可移動
                                    if(CenterX+j<0 || CenterX+j>Option.CubeX) break;//邊界判定
                                    
                                    //移動目標描繪
                                    MoveCube[CenterX+j][CenterY].Type = "move";
                                    addEvent(CenterX+j,CenterY);//增加按鈕事件
                                    break;
                                case 1:
                                    //偵測是否可移動
                                    if(CenterX-j<0 || CenterX-j>Option.CubeX) break;//邊界判定
                                    //移動目標描繪
                                    MoveCube[CenterX-j][CenterY].Type = "move";
                                    addEvent(CenterX-j,CenterY);//增加按鈕事件
                                    break;
                                case 2:
                                    //偵測是否可移動
                                    if(CenterY+j<0 || CenterY+j>Option.CubeY) break;//邊界判定
                                    //移動目標描繪
                                    MoveCube[CenterX][CenterY+j].Type = "move";
                                    addEvent(CenterX,CenterY+j);//增加按鈕事件
                                    break;
                                case 3:
                                    //偵測是否可移動
                                    if(CenterY-j<0 || CenterY-j>Option.CubeY) break;//邊界判定
                                    //移動目標描繪
                                    MoveCube[CenterX][CenterY-j].Type = "move";
                                    addEvent(CenterX,CenterY-j);//增加按鈕事件
                                    break;
                            }
                        }
                    }
                    break;
            }
            rendCube(player.Postion);
        }
        //以下為系統工具
        function getWindowSize(){
            var w = window,
            d = document,
            e = d.documentElement,
            g = d.getElementsByTagName('body')[0],
            x = w.innerWidth || e.clientWidth || g.clientWidth,
            y = w.innerHeight|| e.clientHeight|| g.clientHeight;
            return {W:x,H:y};
        }
        
        function onWindowReSize(){
            var windowSize = getWindowSize();
            LoginView.windowReSize(windowSize);
            RegView.windowReSize(windowSize);
        }
    </script>

</html>
