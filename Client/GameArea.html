<!DOCTYPE html>
<html>
<head>
     <script src="lib/jquery.js"></script>
    <script src="src/Item/Item.js"></script>
    <script src="src/Option.js"></script>
    <script src="../Server/js/ajax.js"></script>
</head>
<body></body>


<script>
        var GameArea,LeftControl,RightControl,TopControl;
        var Option,Turn=0;
        var player=[];
        var FocalVar=1;//焦距 最低1
        var MapCube=[];//存放所有地形資訊
        var House=[];//放房子的
        var BulidCube=[];//顯示建築方塊範圍
        var MoveCube=[];//放移動方塊
        var AttackCube=[];//放攻擊方塊
        /*global UserData 實作於Data*/
        //var USER=new UserData();//用戶資料
        GameAreaInit();
        UpLoad();
        function GameAreaInit(){
            /*global PlayerItem 實作於View*/
            /*global OptionSet 實作於Option.js*/
            Option = new OptionSet();
            //document.body.style.width = Option.GameAreaWidth;
            //document.body.style.height = Option.GameAreaHeight;
            document.body.style.background="#000000";
            GameArea = document.createElement("div");
            //GameArea.style.width = "70%";
            //GameArea.style.height ="70%";
            GameArea.style.backgroundColor = "#000000";
            GameArea.style.margin = "0 auto";
            GameArea.style.position = 'absolute';
            
            GameArea.style.top = "0%";
            GameArea.style.left = "0%";
           document.body.appendChild(GameArea);
           //document.body.style.overflow = 'hidden';
            /*global Item 實作於Item.js*/
            for(var i=0;i<Option.CubeX;i++){
                MapCube.push([]);
                for(var j=0;j<Option.CubeY;j++){
                    /*global MapItem 實作於Item.js*/
                    var item = new MapItem(i,j,'show',true,true);//x,y,type,Moveable,VisiAble
                    MapCube[i].push(item);
                }
            }
            var tmp=new PlayerItem(50,10,1,'A',false,3,true,5,10); //直接宣告在這邊 ajax直接送過來
            player.push(tmp);
            tmp=new PlayerItem(40,10,1,'B',false,3,true,5,10); //直接宣告在這邊 ajax直接送過來
            //x,y,no,type,Moveable,MoveRange,VisiAble,ViewRange,RadioRange
            player.push(tmp);
            
            MapCube[50][10].insert(player[0]);
            MapCube[40][10].insert(player[1]);
             tmp=new BulidingItem(30,10,'A',false,false,5,5);//我軍建築
            House.push(tmp);
             tmp=new BulidingItem(30,11,'A',false,false,5,5);
            House.push(tmp);
             //x,y,type,Moveable,VisiAble,ViewRange
            MapCube[30][10].insert(House[0]);
            View();
            rendCube();
            //直接把畫面到那邊
            window.scrollTo(player[Turn%player.length].X* (Option.CubeSize + Option.CubeLine * 2) * FocalVar, (player[Turn%player.length].Y-5)* (Option.CubeSize + Option.CubeLine * 2) * FocalVar);
            
        }//遊戲畫面初始化
        function Synchronize_res(){
            /*global request 實作於 ajax.js*/
            if (request.readyState == 4) {//完成狀態有好幾種，4代表資料傳回完成
                var data = request.responseText;//取得傳回的資料存在變數中
        		data = JSON.parse(data);
        		console.log(data);
            }
        }//資料同步結果
        function rendCube(){
            for(var i=0;i<Option.CubeX;i++){
                for(var j=0;j<Option.CubeY;j++){
                    if(MapCube[i][j].findTop().VisiAble==true)
                    {
                        switch (MapCube[i][j].findTop().Class) {
                            case 'MapItem':
                                 MapCube[i][j].findTop().Div.style.backgroundColor = "#FFFFFF";
                                break;
                            case 'PlayerItem':
                                MapCube[i][j].findTop().Div.style.backgroundColor = "#FF0000";
                                break;
                            case 'BulidingItem':
                                MapCube[i][j].findTop().Div.style.backgroundColor = "#FF00FF";
                                break;
                            case'MoveItem':
                                MapCube[i][j].findTop().Div.style.backgroundColor = "#FFFF00";
                                break;
                            case 'AttackItem':
                                if(MapCube[i][j].findTop().Under.Class=='MapItem')
                                MapCube[i][j].findTop().Div.style.backgroundColor = "#FFFF00";
                                else
                                MapCube[i][j].findTop().Div.style.backgroundColor = MapCube[i][j].findTop().Under.Div.style.backgroundColor;
                                break;
                            case 'BulidItem':
                                MapCube[i][j].findTop().Div.style.backgroundColor = "#FFFF00";
                                break;
                            default:
                                // code
                        }
                        MapCube[i][j].findTop().getinfo(MapCube[i][j].findTop());
                    }
                    else
                    {
                       MapCube[i][j].findTop().Div.style.backgroundColor = "#012345";//for TEST
                    }
                    GameArea.appendChild(MapCube[i][j].findTop().Div);
                     
                }
            
            }//畫面描繪
            window.scrollTo((player[Turn%player.length].X-7)* (Option.CubeSize + Option.CubeLine * 2) * FocalVar, (player[Turn%player.length].Y-5)* (Option.CubeSize + Option.CubeLine * 2) * FocalVar);
            }
        function Radio(){
            var friends=[],index=0;
            friends.push(player[Turn%player.length]);
            while(index<friends.length)
            {
                var connetRange=friends[index].RadioRange;
                var CenterX=friends[index].X,CenterY=friends[index].Y;
                for(var x=-connetRange;x<=connetRange;x++)
                {
                    var tmp=connetRange-Math.abs(x);
                    for(var y=-tmp;y<=tmp;y++)
                    {
                       if(CenterX+x>=0 && CenterX+x<Option.CubeX && CenterY+y>=0 && CenterY+y<Option.CubeY)//邊界判定
                       if(MapCube[CenterX+x][CenterY+y].findTop()!=MapCube[CenterX+x][CenterY+y])//地圖上方有東西
                        {
                            if(MapCube[CenterX+x][CenterY+y].findTop().Type==player[Turn%player.length].Type)
                            {    
                                var check=true;
                                for(var i=0;i!=index+1;i++)
                                {
                                    if(MapCube[CenterX+x][CenterY+y].findTop()==friends[i])
                                        check=false;
                                }
                                if(check)
                                    friends.push(MapCube[CenterX+x][CenterY+y].findTop());
                            }
                        }
                    }
                }
                index++;
            }
            return friends;
        }
        function View(){
            //全關掉
            for(var i=0;i<Option.CubeX;i++){
                for(var j=0;j<Option.CubeY;j++){
                   MapCube[i][j].findTop().VisiAble=false;
                }
            }
            var connetRange=player[Turn%player.length].RadioRange;//通訊測試範圍
            var friends=Radio();
            for(var i=0;i!=friends.length;i++)
            {
                CalHorizons(friends[i]);
            }
            
            function CalHorizons(friend)
            {
                var Horizons=friend.ViewRange;
                var CenterX=friend.X,CenterY=friend.Y;
                
                for(var x=-Horizons;x<=Horizons;x++)
                {
                    var tmp=Horizons-Math.abs(x);
                    for(var y=-tmp;y<=tmp;y++)
                    {
                        if(CenterX+x>=0 && CenterX+x<Option.CubeX && CenterY+y>=0 && CenterY+y<Option.CubeY)//邊界判定
                        {
                            MapCube[CenterX+x][CenterY+y].VisiAble=true;
                           
                            if(MapCube[CenterX+x][CenterY+y].findTop()!=MapCube[CenterX+x][CenterY+y])
                            {    
                                MapCube[CenterX+x][CenterY+y].findTop().VisiAble=true;
                            }
                        }        
                    }
                }
            }
        }
        function Move(){
            //按下移動按鈕後,先計算MoveRange來放MoveItem
            //在對MoveItem加功能，要刪掉只要把MoveCube清空就行
            //未來可以加移動type如十字
            function addEvent(x,y){
                    var tmp=new MoveItem(x,y,'',false,true);
                    MoveCube.push(tmp);
                    MapCube[x][y].insert(MoveCube[MoveCube.length-1]);
                    tmp.Div.style.cursor='pointer';
                    //滑鼠進入、離開顯示
                    tmp.Div.addEventListener('mouseover',function() {
                        tmp.Div.style.backgroundColor='#FF0000';
                    });
                    tmp.Div.addEventListener('mouseleave',function() {
                        tmp.Div.style.backgroundColor="#FFFF00";
                    });
                    
                    tmp.Div.addEventListener('click',function(){
                    for(var i=0;i!=MoveCube.length;i++){
                        MoveCube[i].earse();
                    }
                    MapCube[player[Turn%player.length].X][player[Turn%player.length].Y].earse(player[Turn%player.length]);
                    player[Turn%player.length].Move(x,y);
                    MapCube[x][y].insert(player[Turn%player.length]);

                    MoveCube.length=0;
                    View();
                    rendCube();
                    parent.VARIABLE.View.GameArea.LeftControl.MoveButton.childNodes[0].nodeValue="開始移動";
                    });
                    
            }
            var CenterX = player[Turn%player.length].X;
            var CenterY = player[Turn%player.length].Y;
            var Horizons=player[Turn%player.length].MoveRange;
            
            for(var x=-Horizons;x<=Horizons;x++)
            {
                var tmp=Horizons-Math.abs(x);
               
                for(var y=-tmp;y<=tmp;y++)
                {
                    if(CenterX+x>=0 && CenterX+x<Option.CubeX && CenterY+y>=0 && CenterY+y<Option.CubeY)//邊界判定 
                    if(MapCube[CenterX+x][CenterY+y].findTop().MoveAble==true) //地形不允許
                    {
                        addEvent(CenterX+x,CenterY+y);
                    }
                }
            }
            rendCube();
        }
        function MoveCancel(){
            for(var i=0;i!=MoveCube.length;i++){
                MoveCube[i].earse();
            }
            MoveCube.length=0;
            rendCube();
        }
        function Bulid(){
             function addEvent(x,y){
                 //按下蓋房子按鈕後,放BulidItem
                //在對BulidItem加功能，要刪掉只要對BulidCude清空
                    var tmp=new BulidItem(x,y,'',false,true);
                    BulidCube.push(tmp);
                    MapCube[x][y].insert(BulidCube[BulidCube.length-1]);
                    tmp.Div.style.cursor='pointer';
                    //滑鼠進入、離開顯示
                    tmp.Div.addEventListener('mouseover',function() {
                        tmp.Div.style.backgroundColor='#FF0000';
                    });
                    tmp.Div.addEventListener('mouseleave',function() {
                        tmp.Div.style.backgroundColor="#FFFF00";
                    });
                    tmp.Div.addEventListener('click',function(){
                    for(var i=0;i!=BulidCube.length;i++){
                        BulidCube[i].earse();
                    }
                    BulidCube.length=0;
                    var buliding=new BulidingItem(x,y,player[Turn%player.length].Type,false,true,5,5);
                    //x,y,type,Moveable,VisiAble,ViewRange,RadioRange
                    MapCube[x][y].insert(buliding);
                    
                    View();
                    rendCube();
                    parent.VARIABLE.View.GameArea.LeftControl.BulidButton.childNodes[0].nodeValue="蓋房子!!";
                    });
                    
                    
            }
            var CenterX = player[Turn%player.length].X;
            var CenterY = player[Turn%player.length].Y;
            var Horizons=1;
            
            for(var x=-Horizons;x<=Horizons;x++)
            {
               
                for(var y=-Horizons;y<=Horizons;y++)
                {
                    if(CenterX+x>=0 && CenterX+x<Option.CubeX && CenterY+y>=0 && CenterY+y<Option.CubeY)//邊界判定 
                    if(MapCube[CenterX+x][CenterY+y].findTop().MoveAble==true) //地形不允許
                    addEvent(CenterX+x,CenterY+y);
                }
            }
            rendCube();
        }
        function BulidCancel(){
            for(var i=0;i!=BulidCube.length;i++){
                BulidCube[i].earse();
            }
            BulidCube.length=0;
            rendCube();
        }
        function Attack(){
            //按下移動按鈕後,來放AttackItem
            //在對AttackItem加功能，要刪掉只要把AttackCube清空就行
            //未來可以加範圍攻擊
            var CenterX = player[Turn%player.length].X;
            var CenterY = player[Turn%player.length].Y;
            var Horizons=player[Turn%player.length].ViewRange;
            
            for(var x=-Horizons;x<=Horizons;x++)
            {
                var tmp=Horizons-Math.abs(x);
               
                for(var y=-tmp;y<=tmp;y++)
                {
                    if(CenterX+x>=0 && CenterX+x<Option.CubeX && CenterY+y>=0 && CenterY+y<Option.CubeY)//邊界判定 
                    {
                        var Attack=new AttackItem(CenterX+x,CenterY+y,'',false,true);
                        AttackCube.push(Attack);
                        MapCube[CenterX+x][CenterY+y].insert(Attack);
                        Attack.Div.style.cursor='pointer';
                        
                    }
                }
            }
            addEvent();
            rendCube();
            function addEvent(){//要使用迴圈加eventlistener要這樣寫
                for(var i=0;i!=AttackCube.length;i++){
                (function(){
                 var tmp=AttackCube[i];
                  tmp.Div.addEventListener('mouseover',function() {
                        tmp.Div.style.backgroundColor='#FF0000';
                    });
                    tmp.Div.addEventListener('mouseleave',function() {
                        if(tmp.Under.Class=='MapItem')
                        tmp.Div.style.backgroundColor="#FFFF00";
                        else
                        tmp.Div.style.backgroundColor=tmp.Under.Div.style.backgroundColor;
                    });
                    tmp.Div.addEventListener('click',function(){
                    for(var j=0;j!=AttackCube.length;j++)
                        AttackCube[j].earse();
                    
                    MapCube[tmp.X][tmp.Y].earse();
                    AttackCube.length=0;
                    View();
                    rendCube();
                    parent.VARIABLE.View.GameArea.LeftControl.AttackButton.childNodes[0].nodeValue="開始攻擊"; },false);
                }());
                
            }
            }
        }
        function AttackCancel(){
            for(var i=0;i!=AttackCube.length;i++)
                AttackCube[i].earse();
            AttackCube.length=0;
            rendCube();
        }
        function Stay() {
            Turn++;
            View();
            rendCube();
        }
        function UpLoad(){
            var updata = new Object();
            updata.House = [];
            updata.Player = [];
            for(var i=0;i!=House.length;i++)
            {
                updata.House.push(House[i].getData());
            }
            for(var i=0;i!=player.length;i++)
            {
                updata.Player.push(player[i].getData());
            }
            //最後在json
            /*global sendGameCommand 實作於ajax*/
            sendGameCommand(JSON.stringify(updata));
        }
</script>


</html>
