<html>
    <head>
        <meta charset="utf-8">
        <title>全民射屁股王</title>
        <script src="src/Item/Item.js"></script>
        <script src="src/Control/left.js"></script>
        <script src="src/Control/right.js"></script>
        <script src="src/Control/top.js"></script>
        <script src="src/Option.js"></script>
        
        <script src="src/View/View.js"></script>
        <script src="src/Data/User.js"></script>
        <script src="lib/socket.io.js"></script>
        
        <style type="text/css">
            /* The CSS */
            body {
                background:#000000;
            }
            select {
                padding:3px;
                margin: 0;
                -webkit-border-radius:4px;
                -moz-border-radius:4px;
                border-radius:4px;
                -webkit-box-shadow: 0 3px 0 #ccc, 0 -1px #fff inset;
                -moz-box-shadow: 0 3px 0 #ccc, 0 -1px #fff inset;
                box-shadow: 0 3px 0 #ccc, 0 -1px #fff inset;
                background: #f8f8f8;
                color:#888;
                border:none;
                outline:none;
                display: inline-block;
                -webkit-appearance:none;
                -moz-appearance:none;
                appearance:none;
                cursor:pointer;
            }
            /* Targetting Webkit browsers only. FF will show the dropdown arrow with so much padding. */
            @media screen and (-webkit-min-device-pixel-ratio:0) {
                select {padding-right:18px}
            }
            label {position:relative}
            label:after {
                content:'<>';
                font:11px "Consolas", monospace;
                color:#aaa;
                -webkit-transform:rotate(90deg);
                -moz-transform:rotate(90deg);
                -ms-transform:rotate(90deg);
                transform:rotate(90deg);
                right:8px; top:2px;
                padding:0 0 2px;
                border-bottom:1px solid #ddd;
                position:absolute;
                pointer-events:none;
            }
            label:before {
                content:'';
                right:6px; top:0px;
                width:20px; height:20px;
                background:#3f85c0;
                position:absolute;
            }
        </style>
    </head>
    <body></body>
    <script>
        var VARIABLE=new Object();//全域變數
        init();
        function setCookie(c_name,value,expiredays) {
        	var exdate=new Date();
            exdate.setDate(exdate.getDate()+expiredays);
        	document.cookie = c_name+ "=" +escape(value) + ((expiredays==null) ? "" : ";expires="+exdate.toGMTString());
        }
        function deleteAllCookies() {
            var cookies = document.cookie.split(";");
            for (var i = 0; i < cookies.length; i++) {
            	var cookie = cookies[i];
            	var eqPos = cookie.indexOf("=");
            	var name = eqPos > -1 ? cookie.substr(0, eqPos) : cookie;
            	document.cookie = name + "=;expires=Thu, 01 Jan 1970 00:00:00 GMT";
            }
        }
        function getcookie(name){
            if (document.cookie.length>0){
                var c_start=document.cookie.indexOf(name + "=")
                if (c_start!=-1){ 
                    c_start=c_start + name.length+1 
                    var c_end = document.cookie.indexOf(";",c_start)
                    if (c_end==-1) c_end=document.cookie.length
                    return unescape(document.cookie.substring(c_start,c_end))
                } 
            }
            return ""
        }
        function init(){
            function checkSave(){
                var User = getcookie("User");
                var PW = getcookie("PW");
                VARIABLE.USER.UserID = getcookie("UserID");
                VARIABLE.USER.RoomID = getcookie("roomID");
                console.log("cookies");
                console.log({User:User,PW:PW,UserID:VARIABLE.USER.UserID,RoomID:VARIABLE.USER.RoomID});
                if(User!="") VARIABLE.Socket.emit("login",{Name:User,PW:PW});/*global VARIABLE in index*/
                else loginViewiInit();
            }
            function getActor(data){
                console.log("getActor:");
                console.log(data);
                if(data.ActorID==0) NewActorViewInit();
        		else{
                    VARIABLE.USER.ActorID = data.ActorID;
                    if(VARIABLE.USER.RoomID!=""){
        		            
                    }else HallViewInit();
                }
            }
            function getMap(data){
                console.log("getMap:");
                console.log(data);
                if(data.status == "secss") VARIABLE.Map = data.Map
            }
            function register_res(data){
                console.log(data);
                if(data.status=='secss') {
                    alert('註冊成功!');
                    loginViewiInit();
                }
            }
            function login(data){
                console.log("login:");
                console.log(data);
                if(data.status=='secss'){
                    VARIABLE.USER.UserID = data.UserID;
                    setCookie('User',data.User,7);
                    setCookie('PW',data.PW,7);
                    if(data.ActorID==null) NewActorViewInit();
                    else {
                        VARIABLE.USER.ActorID = data.ActorID;
                        HallViewInit();
                    }
                }else{
                    alert("登入失敗");
                    loginViewiInit();
                }
            }
            function newActor_res(data){
                console.log(data);
                if(data.status=='secss'){
                    VARIABLE.USER.ActorID = data.ActorID;
                    HallViewInit();
                }else{
                    alert("建立失敗");
                }
            }
            function hallinit(data){
                console.log("hallinit");
                console.log(data);
                if(data.status=='secss'){
                    VARIABLE.USER.ActorName = data.actorName;
                    VARIABLE.USER.Level = data.LV;
                    VARIABLE.USER.RoomID = null;
                    VARIABLE.View.Hall.StatusRender();
                    ViewInit(VARIABLE.View.Hall.self);
                }
            }
            function addRoom_res(data){
                if(data.status=="secss"){
                    //原本在房間內的玩家
                    if(data.RoomID == VARIABLE.USER.RoomID && data.ActorID!=VARIABLE.USER.ActorID && VARIABLE.SCENES=="room") {
                        setTimeout(function() {
                            VARIABLE.Socket.emit("updateRoom",VARIABLE.USER.RoomID);
                        }, 50);
                    }else{
                        VARIABLE.USER.RoomID = data.RoomID;
                        VARIABLE.USER.RoomSide = data.Side;
                        VARIABLE.USER.RoomMaster = data.RoomMaster;
                        RoomViewInit();
                    }
                }
            }
            function checkRoomName(data){
                console.log(data);
                VARIABLE.View.CreateRoom.checkRoomNameRes(data);
            }
            function checkActorName(data){
                VARIABLE.View.NewActor.CheckActorName(data);
            }
            function RoomListUpdate(data){
                if(VARIABLE.SCENES == "hall") VARIABLE.View.Hall.update(data);
            }
            function updateRoom_res(data){
                if(VARIABLE.SCENES == "room") VARIABLE.View.Room.update(data);
            }
            function RoomNewMsg(data) {
                if(data.RoomID==VARIABLE.USER.RoomID){
                    if(VARIABLE.SCENES == "room") VARIABLE.View.Room.getMessage(data.Message);  
                    if(VARIABLE.SCENES == "PreSelect") VARIABLE.View.PreSelect.getMessage(data.Message);  
                    if(VARIABLE.SCENES == "game") VARIABLE.View.GameArea.getMessage(data.Message);  
                } 
            }
            function preSelectInit(data){
                if(data == VARIABLE.USER.RoomID){
                    PreSelectViewInit();
                }
            }
            function updatePreSelect(data){
                if(VARIABLE.SCENES == "PreSelect"){
                    if(data.GameStart) {
                        ViewInit(VARIABLE.View.Block.self);
                        if(data.RoomData.RoomMaster == VARIABLE.USER.ActorID) VARIABLE.Socket.emit("GameStart",data.RoomData);
                    }else VARIABLE.View.PreSelect.update(data);
                }
            }
            function gameStart(data){
                console.log("gameStart");
                console.log(data);
                if(data.RoomData.NO == VARIABLE.USER.RoomID) GameAreaInit(data);
            }
            function gameSynchronize(data){
                console.log("gameSynchronize");
                console.log(data);
                if(VARIABLE.SCENES=="game") {
                    for(var i=0;i<data.Item.length;i++){
                        if(data.Item[i].ActorID==VARIABLE.USER.ActorID){
                            VARIABLE.View.GameArea.setHP(data.Item[i].HP);
                            VARIABLE.View.GameArea.setAP(data.Item[i].AP);
                        }
                    }
                     console.log(data);
                    VARIABLE.View.GameArea.getIframe().contentWindow.update(data);
                }
            }
            function updateGameTime(time){
                if(VARIABLE.SCENES == "game") VARIABLE.View.GameArea.setTime(time);
            }
            function changePostion(data){
                if(data.targetActorID==VARIABLE.USER.ActorID) VARIABLE.View.PreSelect.changePostionRequest(data);
            }
            function changePostionCancel(data){
                if(data.targetActorID==VARIABLE.USER.ActorID) VARIABLE.View.PreSelect.changeRequestCancel(data);
            }
            function changeRequestResult(data){
                if(data.actorID==VARIABLE.USER.ActorID) VARIABLE.View.PreSelect.changeRequestResult(data);
            }
            VARIABLE.Option = new OptionSet();/*global OptionSet 實作於Option.js*/
            VARIABLE.Game = new Object();
            VARIABLE.SCENES = "login";//場景
            VARIABLE.View = new Object();
            VARIABLE.View.Block = new BlockView(getWindowSize(),VARIABLE.Option.getWindowSize()); /*global BlockView 實作於Block.js*/
            ViewInit(VARIABLE.View.Block.self);
            VARIABLE.USER = new UserData();/*global UserData 實作於Data*///用戶資料
            VARIABLE.Socket = io();/*global io in socket.io*/
            VARIABLE.Socket.on('getMap',getMap);
            VARIABLE.Socket.on('getActor',getActor);
            VARIABLE.Socket.on('register_res',register_res);
            VARIABLE.Socket.on('login',login);
            VARIABLE.Socket.on('newActor_res',newActor_res);
            VARIABLE.Socket.on('hallinit',hallinit);
            VARIABLE.Socket.on('addRoom_res',addRoom_res);
            VARIABLE.Socket.on('checkRoomName_res',checkRoomName);
            VARIABLE.Socket.on('newActorNameCheck_res',checkActorName);
            VARIABLE.Socket.on('RoomListUpdate',RoomListUpdate);
            VARIABLE.Socket.on('updateRoom_res',updateRoom_res);
            VARIABLE.Socket.on('RoomNewMsg',RoomNewMsg);
            VARIABLE.Socket.on("preSelect",preSelectInit);
            VARIABLE.Socket.on("updatePreSelect",updatePreSelect);
            VARIABLE.Socket.on("gameStart",gameStart);
            VARIABLE.Socket.on("gameSynchronize",gameSynchronize);
            VARIABLE.Socket.on("updateGameTime",updateGameTime);
            VARIABLE.Socket.on("changePostion",changePostion);
            VARIABLE.Socket.on("changePostionCancel",changePostionCancel);
            VARIABLE.Socket.on("changeRequestResult",changeRequestResult);
            VARIABLE.Socket.emit("getMap");
            checkSave();
            window.addEventListener( 'resize', onWindowReSize, false );
        }//初始化
        function ViewInit(View){
            while(document.body.firstChild)
            document.body.removeChild(document.body.firstChild);
            document.body.appendChild(View);
        }
        function loginViewiInit(){
            VARIABLE.SCENES = "login";
            /*global LoginView 實作於src/View */
            VARIABLE.View.Login = new LoginView(getWindowSize());
            ViewInit(VARIABLE.View.Login.self);
        }//登入畫面描繪
        function registerViewInit(){
            VARIABLE.SCENES = "register";
            /*global RegisterView 實作於src/View.* */
            VARIABLE.View.Register = new RegisterView(getWindowSize());
            ViewInit(VARIABLE.View.Register.self);
        }//註冊
        function NewActorViewInit(){
            VARIABLE.SCENES = "newActor";
            /*global NewActorView 實作於src/View.* */
            VARIABLE.View.NewActor = new NewActorView(getWindowSize(),VARIABLE.Option.getWindowSize());
            ViewInit(VARIABLE.View.NewActor.self);
        }//創建角色
        function HallViewInit(){
            VARIABLE.SCENES = "hall";
            /*global HallView 實作於src/View.* */
            VARIABLE.View.Hall = new HallView(getWindowSize(),VARIABLE.Option.getWindowSize());
            VARIABLE.Socket.emit("hallinit",VARIABLE.USER.ActorID);
        }//大廳描繪
        function CreateRoomViewInit(){
            VARIABLE.SCENES = "createRoom";
            /*global CreateRoomView 實作於src/View.* */
            VARIABLE.View.CreateRoom = new CreateRoomView(getWindowSize(),VARIABLE.Option);
            ViewInit(VARIABLE.View.CreateRoom.self);
        }//建立房間
        function RoomViewInit(){
            VARIABLE.SCENES = "room";
            /*global RoomView 實作於View.* */
            VARIABLE.View.Room = new RoomView(getWindowSize(),VARIABLE.Option);
            VARIABLE.Socket.emit("updateRoom",VARIABLE.USER.RoomID);
            ViewInit(VARIABLE.View.Room.self);
        }//房間內
        function PreSelectViewInit(){
            VARIABLE.SCENES = "PreSelect";
            /*global PreSelectView*/
            VARIABLE.View.PreSelect = new PreSelectView(getWindowSize(),VARIABLE.Option);
            //VARIABLE.Socket.emit("updateRoom",VARIABLE.USER.RoomID);
            ViewInit(VARIABLE.View.PreSelect.self);
        }
        function GameAreaInit(initData){
            //初始化資料
            /*global GameAreaView 實作於View.* */
            VARIABLE.Game.Map = initData['MapData'].Map;
            VARIABLE.View.GameArea = new GameAreaView(getWindowSize(),initData['PlayData'],VARIABLE.Option);
            VARIABLE.SCENES = "game";
            ViewInit(VARIABLE.View.GameArea.self);
            //使用frame可以內嵌另外一頁，在研究
            var html = '<body></body>';
            VARIABLE.View.GameArea.getIframe().contentWindow.document.open();
            VARIABLE.View.GameArea.getIframe().contentWindow.document.write(html);
            VARIABLE.View.GameArea.getIframe().src='src/GameArea.html';
            console.log("遊戲初始化完畢");
        }//遊戲畫面初始化
        //以下為系統工具
        function getWindowSize(){
            var w = window,
            d = document,
            e = d.documentElement,
            g = d.getElementsByTagName('body')[0],
            x = w.innerWidth || e.clientWidth || g.clientWidth,
            y = w.innerHeight|| e.clientHeight|| g.clientHeight;
            return {W:x,H:y};
        }
        function onWindowReSize(){
            var windowSize = getWindowSize();
            VARIABLE.View.Block.windowReSize(windowSize,VARIABLE.Option.getWindowSize());
            switch (VARIABLE.SCENES) {
                case 'login':
                    VARIABLE.View.Login.windowReSize(windowSize);
                    break;
                case 'register':
                    VARIABLE.View.Register.windowReSize(windowSize);
                    break;
                case 'newActor':
                    VARIABLE.View.NewActor.windowReSize(windowSize,VARIABLE.Option.getWindowSize());
                    break;
                case 'hall':
                    VARIABLE.View.Hall.windowReSize(windowSize,VARIABLE.Option.getWindowSize());
                    break;
                case 'createRoom':
                    VARIABLE.View.CreateRoom.windowReSize(windowSize,VARIABLE.Option.getWindowSize());
                    break;
                case 'room':
                    VARIABLE.View.Room.windowReSize(windowSize,VARIABLE.Option.getWindowSize());
                    break;
                case 'optionEdit':
                    VARIABLE.View.OptionEdit.windowReSize(windowSize,VARIABLE.Option.getWindowSize());
                    break;
                case 'PreSelect':
                    VARIABLE.View.PreSelect.windowReSize(windowSize,VARIABLE.Option.getWindowSize());
                    break;
                case 'game':
                    VARIABLE.View.GameArea.windowReSize(windowSize,{W:1280, H:960});
                    break;
            }
        }
    </script>

</html>
